<html lang="en">

<head>
	<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" />
<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.3.3/d3.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.1/crossfilter.min.js"></script>
<script src="http://dc-js.github.io/dc.js/js/dc.js"></script>
<link href="http://dc-js.github.io/dc.js/css/dc.css" rel="stylesheet" />
</head>

<body>
	<div id="timeOfDayBarChart"></div>
	<div id="dateBarChart"></div>
	<div id="temperatureChart"></div>
	<div class='table table-hover' id='sap-table'>
	</div>
	
	<script type="text/javascript">
	/**
	 * Created by ddcryang on 2/18/15.
	 */
	var data =
	    [{
	        "id": 1,
	        "startTime": 1420344905.166000000,
	        "endTime": 1420344913.088000000,
	        "sapQuantity": 1.05,
			"temperature": 34,
	        "duration": 7.922000000
	    }, {
	        "id": 2,
	        "startTime": 1420401228.438000000,
	        "endTime": 1420401241.434000000,
	        "sapQuantity": 1.35,
			"temperature": 36,
	        "duration": 12.996000000
	    }, {
	        "id": 3,
	        "startTime": 1420417468.746000000,
	        "endTime": 1420417475.122000000,
	        "sapQuantity": 1.35,
			"temperature": 38,
	        "duration": 6.376000000
	    }, {
	        "id": 4,
	        "startTime": 1420417654.694000000,
	        "endTime": 1420417663.515000000,
	        "sapQuantity": 1.35,
			"temperature": 49,
	        "duration": 8.821000000
	    }, {
	        "id": 5,
	        "startTime": 1420418703.628000000,
	        "endTime": 1420418711.708000000,
	        "sapQuantity": 1.35,
			"temperature": 47,
	        "duration": 8.080000000
	    }, {
	        "id": 6,
	        "startTime": 1420496281.034000000,
	        "endTime": 1420496288.312000000,
	        "sapQuantity": 1.35,
			"temperature": 34,
	        "duration": 7.278000000
	    }, {
	        "id": 7,
	        "startTime": 1420496364.430000000,
	        "endTime": 1420496369.946000000,
	        "sapQuantity": 1.35,
			"temperature": 36,
	        "duration": 5.516000000
	    }, {
	        "id": 8,
	        "startTime": 1420496415.970000000,
	        "endTime": 1420496425.255000000,
	        "sapQuantity": 1.35,
			"temperature": 43,
	        "duration": 9.285000000
	    }, {
	        "id": 9,
	        "startTime": 1420496602.036000000,
	        "endTime": 1420496608.328000000,
	        "sapQuantity": 1.35,
			"temperature": 36,
	        "duration": 6.292000000
	    }, {
	        "id": 10,
	        "startTime": 1420757742.759000000,
	        "endTime": 1420757749.206000000,
	        "sapQuantity": 1.35,
			"temperature": 39,	
	        "duration": 6.447000000
	    }, {
	        "id": 11,
	        "startTime": 1420757771.842000000,
	        "endTime": 1420757777.515000000,
	        "sapQuantity": 1.35,
			"temperature": 42,	
	        "duration": 5.673000000
	    }, {
	        "id": 12,
	        "startTime": 1420802452.067000000,
	        "endTime": 1420802462.504000000,
	        "sapQuantity": 1.35,
			"temperature": 41,	
	        "duration": 10.437000000
	    }, {
	        "id": 13,
	        "startTime": 1423620236.248000000,
	        "endTime": 1423620252.664000000,
	        "sapQuantity": 1.35,
			"temperature": 34,	
	        "duration": 16.416000000
	    }, {
	        "id": 14,
	        "startTime": 1423624498.660000000,
	        "endTime": 1423624499.660000000,
	        "sapQuantity": 1.5,
			"temperature": 33,	
	        "duration": 1
	    }, {
	        "id": 15,
	        "startTime": 1423626559.061000000,
	        "endTime": 1423626572.170000000,
	        "sapQuantity": 1.5,
			"temperature": 31,	
	        "duration": 13.109000000
	    }, {
	        "id": 16,
	        "startTime": 1423759985.747000000,
	        "endTime": 1423759995.864000000,
	        "sapQuantity": 1.5,
			"temperature": 30,	
	        "duration": 10.117000000
	    }, {
	        "id": 17,
	        "startTime": 1423878213.814000000,
	        "endTime": 1423878220.603000000,
	        "sapQuantity": 1.5,
			"temperature": 44,	
	        "duration": 6.789000000
	    }]


		data.forEach(function (d) {
		    d.dd = new Date(d.startTime * 1000);
		    d.day = d3.time.day(d.dd);
		    d.hour = d.dd.getHours();
		});

		var ndx = crossfilter(data);

		var dateDimension = ndx.dimension(function (d) {
		    return d.dd;
		});

		var hourlyDimension = ndx.dimension(function (d) {
		    return d.hour;
		});
		
		var dailyDimension = ndx.dimension(function (d) {
		    return d.day;
		});
		
		var tempDimension = ndx.dimension(function (d) {
			return d.temperature;
		});
				
		var hourlyGroup = hourlyDimension.group().reduceSum(function (d) {
	        return d.sapQuantity;
	    });
	
		var tempGroup = tempDimension.group().reduceSum(function(d) {
			return d.sapQuantity;
		});
	
		var dailyGroup = dailyDimension.group().reduceSum(function (d) {
	        return d.sapQuantity;
	    });

		

	var minDate = dateDimension.bottom(1)[0].dd;
	var maxDate = dateDimension.top(1)[0].dd;

	var barChart = dc.barChart("#dateBarChart");
	barChart.width(500)
	    .height(250)
	    .dimension(dailyDimension)
	    .group(dailyGroup)
        .elasticY(true)
	    .xUnits(d3.time.days)
	    .x(d3.time.scale().domain([minDate, maxDate]).nice(d3.time.day))
		.xAxisLabel('Date')
		.yAxisLabel('Gallons of Sap')
	    .xAxis().tickFormat(function (x) {
	        return (x.getMonth() + 1) + "/" + (x.getDate());
	    });
	
	var minTemp = tempDimension.bottom(1)[0].temperature;
	var maxTemp = tempDimension.top(1)[0].temperature;
	

	var tempChart = dc.barChart("#temperatureChart");
	
	tempChart
		.width(500)
		.height(250)
		.dimension(tempDimension)
		.group(tempGroup)
		.elasticY(true)
		.x(d3.scale.linear().domain([minTemp,maxTemp]))
		.xAxisLabel('Temperature')
		.yAxisLabel('Gallons of Sap');
		

	var timeFormat = ['12 AM', '1 AM', '2 AM', '3 AM', '4 AM', '5 AM', '6 AM', '7 AM', '8 AM', '9 AM', '10 AM', '11 AM', '12 PM', '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM', '8 PM', '9 PM', '10 PM', '11 PM', '12 PM'];
	
	var dateBarChart = dc.barChart("#timeOfDayBarChart");
	dateBarChart.width(500).height(250)
	    .dimension(hourlyDimension)
	    .group(hourlyGroup).x(d3.scale.linear().domain([0, 24]))
	    .elasticY(true)
		.elasticX(true)
		.xAxisLabel('Time of day')
		.yAxisLabel('Gallons of Sap')
	    .xAxis().tickFormat(
	    function (h) {
	       return timeFormat[h];
	    });


	dc.dataTable('#sap-table')
	    .dimension(dateDimension)
	    .group(function (d) {
	        return "sap quantity"
	        // var format = d3.time.format('%c');
	        //             return format(d.dd);
	    })
	    .size(30) // (optional) max number of records to be shown, :default = 25
	    .columns([
	        function (d) {
	            var format = d3.time.format('%c');
	            return format(d.dd);
	        },    // d['date'], ie, a field accessor; capitalized automatically
	        'sapQuantity',    // ...
	        'duration',   // ...
	    ])
	    .sortBy(function (d) {
	        return d.dd;
	    })
	    .order(d3.ascending)
	    .renderlet(function (table) {
	        table.selectAll('#sap-table').classed('info', true);
	    });

	dc.renderAll();

	</script>
</body>
</html>